<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Time Warp — Web Interpreter Demo</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #container{ display:flex; gap:16px }
    #editor{ width:50%; }
    #graphicsPane{ width:50%; }
    textarea { width:100%; height:220px; font-family: monospace; font-size: 13px }
    #console{ height:150px; background:#111; color:#bada55; font-family: monospace; padding:8px; overflow:auto }
    .controls{ margin-top:8px }
    canvas{ border: 1px solid #333; background:white }
  </style>
</head>
<body>
  <h1>Time Warp — Web Interpreter Demo</h1>
  <p>Demo page to exercise the new interpreter + graphics. Choose language/sample and press Run.</p>

  <div id="container">
    <div id="editor">
      <label for="prog">Program</label>
      <textarea id="prog">FORWARD 100
RIGHT 90
FORWARD 100
PRINT Done
END</textarea>

      <div class="controls">
        <button id="run">Run</button>
        <button id="stop">Stop</button>
        <button id="reset">Reset</button>
        <select id="sample">
          <option value="logo">Logo: square</option>
          <option value="pilot">PILOT: variables + output</option>
          <option value="basic">BASIC: simple loop</option>
        </select>
      </div>

      <h3>Console</h3>
      <div id="console"></div>

      <h3>Variables</h3>
      <pre id="vars">(none)</pre>
    </div>

    <div id="graphicsPane">
      <label>Graphics</label>
      <canvas id="graphicsCanvas" width="640" height="480"></canvas>
      <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
        <button id="clear">Clear</button>
        <button id="home">Home</button>
        <button id="pens">Toggle Pen</button>
      </div>
      <div style="margin-top:8px;">
        <span>Position: (<span id="turtleX">0</span>, <span id="turtleY">0</span>)</span>
        &nbsp; Heading: <span id="turtleHeading">0</span>
      </div>
    </div>
  </div>

  <script src="js/graphics.js"></script>
  <script src="js/interpreter.js"></script>
  <script>
    // wire up
    const canvasId = 'graphicsCanvas';
    window.createTurtle(canvasId); // create and bind
    const turtle = window.createTurtle(canvasId);

    const I = new window.WebInterpreter();
    I.setGraphics(turtle);

    const consoleEl = document.getElementById('console');
    const varsEl = document.getElementById('vars');

    I.onOutput = (m)=>{ consoleEl.textContent += m; consoleEl.scrollTop = consoleEl.scrollHeight; };
    I.onError = (m, line)=>{ consoleEl.textContent += 'ERROR: '+m+' (line '+line+')\n'; };
    I.onFinished = ()=>consoleEl.textContent += '\n--- finished ---\n';
    I.onVariableChanged = (name, value) => { const items = I.getVariables().map(v=>v.name+': '+v.value).join('\n'); varsEl.textContent = items || '(none)'; };

    document.getElementById('run').addEventListener('click', ()=>{
      consoleEl.textContent = '';
      I.load(document.getElementById('prog').value);
      I.run().catch(e=>consoleEl.textContent += 'Runtime error: '+e.message+'\n');
    });
    document.getElementById('stop').addEventListener('click', ()=>{ I.stop(); });
    document.getElementById('reset').addEventListener('click', ()=>{ I.reset(); consoleEl.textContent=''; varsEl.textContent='(none)'; if (turtle) turtle.clearScreen(); });
    document.getElementById('clear').addEventListener('click', ()=>turtle && turtle.clearScreen());
    document.getElementById('home').addEventListener('click', ()=>turtle && turtle.home());
    document.getElementById('pens').addEventListener('click', ()=>{ if (turtle) { if (turtle.isPenDown) turtle.penUp(); else turtle.penDown(); } });

    document.getElementById('sample').addEventListener('change', (e)=>{
      const v = e.target.value;
      if (v==='logo') document.getElementById('prog').value = 'FORWARD 100\nRIGHT 90\nFORWARD 100\nRIGHT 90\nFORWARD 100\nRIGHT 90\nFORWARD 100\nPRINT Done\nEND';
      if (v==='pilot') document.getElementById('prog').value = 'R:10->X\nT: Hello *X*\nE:';
      if (v==='basic') document.getElementById('prog').value = '10 FOR I = 1 TO 4\n20 PRINT "loop "\n30 NEXT\n100 END';
    });

    // update turtle info periodically
    setInterval(()=>{
      if (!turtle) return;
      const pos = turtle.getPosition();
      document.getElementById('turtleX').textContent = Math.round(pos.x);
      document.getElementById('turtleY').textContent = Math.round(pos.y);
      document.getElementById('turtleHeading').textContent = Math.round(turtle.getHeading());
    }, 250);
  </script>
</body>
</html>